# =============================================================================
# Loka CI — Tests, Lint, Production Image
# =============================================================================
# This workflow handles code quality and the base production image.
#
# RL training and inference images have their own independent workflows:
#   - docker-train.yml    — triggered by training-related file changes
#   - docker-inference.yml — triggered by inference-related file changes
#                            or manual dispatch to deploy a trained model
#
# ┌───────┐  ┌────────────┐  ┌──────────────────┐
# │ lint  │  │ unit-tests │  │ integration-tests │   ← parallel
# └───┬───┘  └─────┬──────┘  └────────┬─────────┘
#     └─────────────┼─────────────────┘
#                   ▼
#     ┌─────────────────────────┐
#     │     quality-gate        │   ← fan-in checkpoint
#     └────────────┬────────────┘
#                  ▼
#            ┌──────────┐
#            │   prod   │   ← production Docker image
#            └──────────┘
#
# Required GitHub Secrets:
#   DOCKER_REGISTRY   – e.g. "ghcr.io"
#   DOCKER_USERNAME   – registry username
#   DOCKER_PASSWORD   – registry token (PAT with packages:write)
#
# Tagging (via docker/metadata-action):
#   Push to main    → :main, :sha-abc1234
#   Tag v1.2.3      → :1.2.3, :1.2, :1, :latest
# =============================================================================

name: CI/CD

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:          # manual trigger for re-runs

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true   # cancel stale runs on the same branch/PR

# ─── Shared env ─────────────────────────────────────────────────────
env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/loka

# ─── Jobs ───────────────────────────────────────────────────────────

jobs:

  # ================================================================
  # Phase 1 — Quality gates (run in parallel)
  # ================================================================

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff
        run: ruff check src/ tests/

  # ── Unit tests ───────────────────────────────────────────────────

  unit-tests:
    name: Unit Tests (py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false        # let other versions finish even if one fails
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: pip-${{ matrix.python-version }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install gymnasium numba pandas pyarrow

      - name: Run unit tests
        run: pytest tests/test_coordinates.py tests/test_tools.py tests/test_orbital_env.py -v --tb=short

  # ── Integration tests ───────────────────────────────────────────

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-3.11-${{ hashFiles('pyproject.toml') }}
          restore-keys: pip-3.11-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install gymnasium numba pandas pyarrow

      - name: Run integration tests
        run: pytest tests/test_integration.py -v --tb=short

  # ================================================================
  # Phase 2 — Quality gate (fan-in)
  # ================================================================

  quality-gate:
    name: Quality Gate
    needs: [lint, unit-tests, integration-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check all gates passed
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "❌ Lint failed"
            exit 1
          fi
          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "❌ Unit tests failed"
            exit 1
          fi
          if [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
            echo "❌ Integration tests failed"
            exit 1
          fi
          echo "✅ All quality gates passed"

  # ================================================================
  # Phase 3 — Production Docker image (only on push to main/tags)
  # ================================================================

  docker-prod:
    name: Docker — Production
    needs: quality-gate
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build & push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=prod
          cache-to: type=gha,mode=max,scope=prod
          platforms: linux/amd64
